<Window x:Class="DocTransform.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:viewmodels="clr-namespace:DocTransform.ViewModels"
        mc:Ignorable="d"
        Title="Excel到Word数据映射工具"
        Height="680" Width="950"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="13"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{materialDesign:MaterialDesignFont}"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        WindowStyle="None"
        ResizeMode="CanResizeWithGrip"
        AllowsTransparency="True"
        BorderThickness="0">

    <Window.DataContext>
        <viewmodels:MainViewModel />
    </Window.DataContext>

    <materialDesign:DialogHost Identifier="RootDialog">
        <Grid>

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- 自定义标题栏 -->
            <materialDesign:ColorZone Grid.Row="0" Mode="PrimaryDark" Padding="8"
                                      materialDesign:ElevationAssist.Elevation="Dp4"
                                      MouseLeftButtonDown="ColorZone_MouseLeftButtonDown">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 图标和标题 -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="8,0">
                        <materialDesign:PackIcon Kind="FileReplace" Height="24" Width="24" VerticalAlignment="Center" />
                        <TextBlock Margin="12,0,0,0" VerticalAlignment="Center" FontSize="16" FontWeight="Medium">
                            Excel到Word数据映射工具
                        </TextBlock>
                    </StackPanel>

                    <!-- 窗口控制按钮 -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <Button Style="{StaticResource MaterialDesignFlatButton}"
                                Click="MinimizeButton_Click"
                                ToolTip="最小化">
                            <materialDesign:PackIcon Kind="WindowMinimize" />
                        </Button>
                        <Button x:Name="MaximizeButton" Style="{StaticResource MaterialDesignFlatButton}"
                                Click="MaximizeButton_Click"
                                ToolTip="最大化">
                            <materialDesign:PackIcon Kind="WindowMaximize" />
                        </Button>
                        <Button Style="{StaticResource MaterialDesignFlatButton}"
                                Click="CloseButton_Click"
                                ToolTip="关闭">
                            <materialDesign:PackIcon Kind="WindowClose" />
                        </Button>
                    </StackPanel>
                </Grid>
            </materialDesign:ColorZone>


            <materialDesign:Card Grid.Row="1" Margin="16" UniformCornerRadius="8" Padding="0"
                                 AllowDrop="True">
                <DockPanel AllowDrop="True">

                    <!-- 底部状态栏 -->
                    <materialDesign:Card DockPanel.Dock="Bottom" Margin="0"
                                         materialDesign:ElevationAssist.Elevation="Dp2"
                                         UniformCornerRadius="0">
                        <Grid Margin="16,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- 状态消息 -->
                            <TextBlock Grid.Column="0" Text="{Binding StatusMessage}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis" />

                            <!-- 处理进度 -->
                            <Border Grid.Column="1" Margin="8,0,0,0"
                                    Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock VerticalAlignment="Center">
                                    <Run Text="{Binding ProcessedItems, Mode=OneWay}" />
                                    <Run Text="/" />
                                    <Run Text="{Binding TotalItems, Mode=OneWay}" />
                                </TextBlock>
                            </Border>

                            <!-- 按钮：打开输出文件夹 -->
                            <Button Grid.Column="2" Margin="16,0,0,0"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Command="{Binding OpenOutputFolderCommand}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FolderOpen" VerticalAlignment="Center" />
                                    <TextBlock Margin="8,0,0,0" Text="打开输出文件夹" />
                                </StackPanel>
                            </Button>
                        </Grid>
                    </materialDesign:Card>

                    <!-- 主要内容区 -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" AllowDrop="True">
                        <StackPanel Margin="16" AllowDrop="True">

                            <!-- 拖放提示 - 使其更醒目 -->
                            <materialDesign:Card Margin="0,0,0,16"
                                                 UniformCornerRadius="4"
                                                 Background="{DynamicResource MaterialDesignLightBlueBackground}"
                                                 BorderBrush="{DynamicResource PrimaryHueMidBrush}"
                                                 BorderThickness="1"
                                                 AllowDrop="True">
                                <Grid Margin="16,12">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <materialDesign:PackIcon Kind="DragVariant" VerticalAlignment="Center"
                                                                 Width="24" Height="24"
                                                                 Foreground="{DynamicResource PrimaryHueMidBrush}" />
                                        <TextBlock Margin="12,0,0,0" Text="您可以将Excel文件或Word模板文件拖放到此窗口"
                                                   VerticalAlignment="Center"
                                                   FontWeight="Medium" />
                                    </StackPanel>
                                </Grid>
                            </materialDesign:Card>

                            <!-- 文件选择区域 -->
                            <materialDesign:Card Margin="0,0,0,16" UniformCornerRadius="4">
                                <StackPanel Margin="16">
                                    <TextBlock Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                               Margin="0,0,0,16" FontWeight="Medium">
                                        文件选择
                                    </TextBlock>

                                    <!-- 表格模式切换 -->
                                    <DockPanel Margin="0,0,0,16">
                                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                                            <TextBlock Text="多表格模式" VerticalAlignment="Center" Margin="0,0,8,0"
                                                       ToolTip="启用后可导入多个Excel表格并自动匹配数据" />

                                            <!-- 替换ToggleButton为普通Button -->
                                            <Button Command="{Binding ToggleTableModeCommand}"
                                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                                    ToolTip="切换表格模式">
                                                <materialDesign:PackIcon
                                                    Kind="{Binding IsMultiTableMode, Converter={StaticResource BoolToIconConverter}, ConverterParameter='ToggleOn;ToggleOff'}"
                                                    Width="24" Height="24" />
                                            </Button>
                                        </StackPanel>
                                        <TextBlock Style="{StaticResource MaterialDesignBody1TextBlock}"
                                                   VerticalAlignment="Center" FontWeight="Medium">
                                            <Run Text="当前模式: " />
                                            <Run x:Name="ModeText" FontWeight="Bold">
                                                <Run.Style>
                                                    <Style TargetType="Run">
                                                        <Setter Property="Text" Value="单表格" />
                                                        <Setter Property="Foreground"
                                                                Value="{DynamicResource PrimaryHueMidBrush}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsMultiTableMode}"
                                                                         Value="True">
                                                                <Setter Property="Text" Value="多表格" />
                                                                <Setter Property="Foreground"
                                                                        Value="{DynamicResource SecondaryHueMidBrush}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Run.Style>
                                            </Run>
                                        </TextBlock>
                                    </DockPanel>

                                    <!-- Excel文件选择 - 支持多表格 -->
                                    <DockPanel Margin="0,0,0,8">
                                        <Button DockPanel.Dock="Right" Margin="8,0,0,0"
                                                Style="{StaticResource MaterialDesignRaisedLightButton}"
                                                Command="{Binding BrowseExcelFileCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <materialDesign:PackIcon Kind="FileExcel" />
                                                <TextBlock Margin="8,0,0,0"
                                                           Text="{Binding IsMultiTableMode, Converter={StaticResource BoolToStringConverter}, ConverterParameter='添加Excel;浏览'}" />
                                            </StackPanel>
                                        </Button>
                                        <materialDesign:Card>
                                            <DockPanel Margin="8">
                                                <materialDesign:PackIcon Kind="FileExcel" DockPanel.Dock="Left"
                                                                         VerticalAlignment="Center"
                                                                         Foreground="#1F7244" />
                                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center"
                                                           Text="{Binding ExcelFilePath, Converter={StaticResource FilenameOnlyConverter}}"
                                                           TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding ExcelFilePath}"
                                                           Visibility="{Binding IsMultiTableMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock"
                                                               BasedOn="{StaticResource MaterialDesignTextBlock}">
                                                            <Setter Property="Text" Value="未选择Excel文件" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding ExcelFilePath}" Value="">
                                                                    <Setter Property="Text" Value="未选择Excel文件" />
                                                                    <Setter Property="Foreground"
                                                                            Value="{DynamicResource MaterialDesignBodyLight}" />
                                                                    <Setter Property="FontStyle" Value="Italic" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>

                                                <!-- 多表格模式显示摘要 -->
                                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center"
                                                           Visibility="{Binding IsMultiTableMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock"
                                                               BasedOn="{StaticResource MaterialDesignTextBlock}">
                                                            <Setter Property="Text" Value="未添加Excel表格" />
                                                            <Setter Property="Foreground"
                                                                    Value="{DynamicResource MaterialDesignBodyLight}" />
                                                            <Setter Property="FontStyle" Value="Italic" />
                                                            <Style.Triggers>
                                                                <DataTrigger
                                                                    Binding="{Binding MultiTableData.Tables.Count}"
                                                                    Value="0">
                                                                    <Setter Property="Text" Value="未添加Excel表格" />
                                                                    <Setter Property="Foreground"
                                                                            Value="{DynamicResource MaterialDesignBodyLight}" />
                                                                    <Setter Property="FontStyle" Value="Italic" />
                                                                </DataTrigger>
                                                                <DataTrigger
                                                                    Binding="{Binding MultiTableData.Tables.Count}"
                                                                    Value="1">
                                                                    <Setter Property="Text" Value="已添加1个表格" />
                                                                    <Setter Property="Foreground"
                                                                            Value="{DynamicResource MaterialDesignBody}" />
                                                                    <Setter Property="FontStyle" Value="Normal" />
                                                                </DataTrigger>
                                                                <MultiDataTrigger>
                                                                    <MultiDataTrigger.Conditions>
                                                                        <Condition
                                                                            Binding="{Binding MultiTableData.Tables.Count}"
                                                                            Value="0" />
                                                                    </MultiDataTrigger.Conditions>
                                                                    <Setter Property="Text"
                                                                            Value="{Binding MultiTableData.Tables.Count, StringFormat='已添加{0}个表格'}" />
                                                                    <Setter Property="Foreground"
                                                                            Value="{DynamicResource MaterialDesignBody}" />
                                                                    <Setter Property="FontStyle" Value="Normal" />
                                                                </MultiDataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </DockPanel>
                                        </materialDesign:Card>
                                    </DockPanel>

                                    <!-- 添加多表格列表显示 -->
                                    <materialDesign:Card Margin="0,0,0,16"
                                                         Visibility="{Binding IsMultiTableMode, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                         UniformCornerRadius="4">
                                        <StackPanel>
                                            <!-- 表格列表标题 -->
                                            <materialDesign:ColorZone Mode="PrimaryLight" CornerRadius="4,4,0,0">
                                                <DockPanel Margin="8">
                                                    <materialDesign:PackIcon Kind="TableMultiple"
                                                                             VerticalAlignment="Center" />
                                                    <TextBlock Text="已添加的表格" Margin="8,0,0,0" FontWeight="Medium" />
                                                    <TextBlock
                                                        Text="{Binding MultiTableData.TotalRowCount, StringFormat='(共{0}行数据)'}"
                                                        Margin="8,0,0,0"
                                                        Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                                </DockPanel>
                                            </materialDesign:ColorZone>

                                            <!-- 表格列表 -->
                                            <ItemsControl ItemsSource="{Binding MultiTableData.Tables}"
                                                          MaxHeight="150"
                                                          ScrollViewer.VerticalScrollBarVisibility="Auto">
                                                <ItemsControl.Template>
                                                    <ControlTemplate TargetType="ItemsControl">
                                                        <ScrollViewer>
                                                            <ItemsPresenter />
                                                        </ScrollViewer>
                                                    </ControlTemplate>
                                                </ItemsControl.Template>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <materialDesign:Card Margin="4" UniformCornerRadius="4">
                                                            <DockPanel Margin="8,4">
                                                                <Button DockPanel.Dock="Right"
                                                                        Style="{StaticResource MaterialDesignIconButton}"
                                                                        Command="{Binding DataContext.RemoveTableCommand, 
                                          RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="删除此表格">
                                                                    <materialDesign:PackIcon Kind="DeleteOutline" />
                                                                </Button>
                                                                <StackPanel>
                                                                    <TextBlock Text="{Binding SourceFileName}"
                                                                               FontWeight="Medium"
                                                                               TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Text="{Binding RowCount, StringFormat='共{0}行数据'}"
                                                                        Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                        Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                                                </StackPanel>
                                                            </DockPanel>
                                                        </materialDesign:Card>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- 匹配键选择 -->
                                            <DockPanel Margin="16,8" LastChildFill="True">
                                                <TextBlock Text="选择用于匹配记录的列："
                                                           DockPanel.Dock="Left" VerticalAlignment="Center"
                                                           Margin="0,0,8,0" />
                                                <ComboBox ItemsSource="{Binding AvailableKeyColumns}"
                                                          SelectedItem="{Binding SelectedKeyColumn}"
                                                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                                          materialDesign:HintAssist.Hint="选择一个在所有表格中存在的列作为匹配键"
                                                          DisplayMemberPath="."
                                                          HorizontalAlignment="Stretch">
                                                    <ComboBox.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <VirtualizingStackPanel />
                                                        </ItemsPanelTemplate>
                                                    </ComboBox.ItemsPanel>
                                                </ComboBox>
                                            </DockPanel>

                                            <!-- 合并结果显示 -->
                                            <DockPanel Margin="16,0,16,8"
                                                       Visibility="{Binding SelectedKeyColumn, Converter={StaticResource StringToVisibilityConverter}}">
                                                <materialDesign:PackIcon Kind="LinkVariant" VerticalAlignment="Center" />
                                                <TextBlock Margin="8,0,0,0">
                                                    <TextBlock.Text>
                                                        <MultiBinding StringFormat="已使用 {0} 列合并数据，共有 {1} 条记录">
                                                            <Binding Path="SelectedKeyColumn" />
                                                            <Binding Path="MultiTableData.MergedRows.Count" />
                                                        </MultiBinding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                            </DockPanel>
                                        </StackPanel>
                                    </materialDesign:Card>


                                    <!-- Word模板选择 -->
                                    <DockPanel Margin="0,0,0,8">
                                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                                            <Button Margin="8,0,8,0"
                                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                                    Command="{Binding CheckPlaceholdersCommand}"
                                                    ToolTip="检查模板中的占位符"
                                                    Visibility="{Binding WordTemplatePath, Converter={StaticResource StringToVisibilityConverter}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="FileFind" />
                                                    <TextBlock Margin="8,0,0,0" Text="检查占位符" />
                                                </StackPanel>
                                            </Button>
                                            <Button Margin="0,0,0,0"
                                                    Style="{StaticResource MaterialDesignRaisedLightButton}"
                                                    Command="{Binding BrowseWordTemplateCommand}">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="FileWord" />
                                                    <TextBlock Margin="8,0,0,0" Text="浏览" />
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>

                                        <materialDesign:Card>
                                            <DockPanel Margin="8">
                                                <materialDesign:PackIcon Kind="FileWord" DockPanel.Dock="Left"
                                                                         VerticalAlignment="Center"
                                                                         Foreground="#2B579A" />
                                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center"
                                                           Text="{Binding WordTemplatePath, Converter={StaticResource FilenameOnlyConverter}}"
                                                           TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding WordTemplatePath}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock"
                                                               BasedOn="{StaticResource MaterialDesignTextBlock}">
                                                            <Setter Property="Text" Value="未选择Word模板" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding WordTemplatePath}"
                                                                             Value="">
                                                                    <Setter Property="Text" Value="未选择Word模板" />
                                                                    <Setter Property="Foreground"
                                                                            Value="{DynamicResource MaterialDesignBodyLight}" />
                                                                    <Setter Property="FontStyle" Value="Italic" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </DockPanel>
                                        </materialDesign:Card>
                                    </DockPanel>

                                    <!-- Excel模板选择区域 -->
                                    <Grid Margin="0,0,0,16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Excel模板标题和启用开关 -->
                                        <DockPanel Grid.Row="0" Grid.Column="0" LastChildFill="True">
                                            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                                                <TextBlock Text="启用Excel模板" VerticalAlignment="Center" Margin="0,0,8,0"
                     ToolTip="启用后将同时生成Excel文件"/>
                                                <ToggleButton IsChecked="{Binding UseExcelTemplate}"/>
                                            </StackPanel>
                                            <TextBlock Style="{StaticResource MaterialDesignSubtitle1TextBlock}" 
               Text="Excel模板"
               VerticalAlignment="Center"/>
                                        </DockPanel>

                                        <!-- 浏览和检查按钮 -->
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                            <Button Margin="8,0,0,0"
            Style="{StaticResource MaterialDesignRaisedLightButton}"
            ToolTip="浏览Excel模板"
            Command="{Binding BrowseExcelTemplateCommand}">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="FileExcel" />
                                                    <TextBlock Margin="8,0,0,0" Text="浏览"/>
                                                </StackPanel>
                                            </Button>
                                            <Button Margin="8,0,0,0"
            Style="{StaticResource MaterialDesignOutlinedButton}"
            Command="{Binding CheckExcelPlaceholdersCommand}"
            ToolTip="检查Excel模板中的占位符"
            IsEnabled="{Binding ExcelTemplatePath, Converter={StaticResource StringNotEmptyToBoolConverter}}">
                                                <materialDesign:PackIcon Kind="Magnify"/>
                                            </Button>
                                            <Button Margin="8,0,0,0"
            Style="{StaticResource MaterialDesignOutlinedButton}"
            Command="{Binding ClearExcelTemplateCommand}"
            ToolTip="清除Excel模板"
            IsEnabled="{Binding ExcelTemplatePath, Converter={StaticResource StringNotEmptyToBoolConverter}}">
                                                <materialDesign:PackIcon Kind="Close"/>
                                            </Button>
                                        </StackPanel>

                                        <!-- Excel模板路径显示 -->
                                        <materialDesign:Card Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,8,0,0"
                     IsEnabled="{Binding UseExcelTemplate}">
                                            <DockPanel Margin="8">
                                                <materialDesign:PackIcon Kind="FileExcel" DockPanel.Dock="Left" 
                                 VerticalAlignment="Center" Foreground="#1F7244"/>
                                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" 
                   Text="{Binding ExcelTemplatePath, Converter={StaticResource FilenameOnlyConverter}}" 
                   TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                   ToolTip="{Binding ExcelTemplatePath}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock" BasedOn="{StaticResource MaterialDesignTextBlock}">
                                                            <Setter Property="Text" Value="未选择Excel模板"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding ExcelTemplatePath}" Value="">
                                                                    <Setter Property="Text" Value="未选择Excel模板"/>
                                                                    <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBodyLight}"/>
                                                                    <Setter Property="FontStyle" Value="Italic"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </DockPanel>
                                        </materialDesign:Card>
                                    </Grid>

                                    <!-- Excel占位符显示区域 -->
                                    <materialDesign:Card Margin="0,0,0,16" 
                 UniformCornerRadius="4"
                 Visibility="{Binding DetectedExcelPlaceholders.Count, Converter={StaticResource NotZeroToVisibilityConverter}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- 标题 -->
                                            <materialDesign:ColorZone Grid.Row="0" Mode="PrimaryLight" CornerRadius="4,4,0,0">
                                                <DockPanel Margin="8">
                                                    <materialDesign:PackIcon Kind="Bracket" VerticalAlignment="Center"/>
                                                    <TextBlock Text="Excel模板中的占位符" Margin="8,0,0,0" FontWeight="Medium"/>
                                                    <TextBlock Text="{Binding DetectedExcelPlaceholders.Count, StringFormat='(共{0}个)'}" 
                       Margin="8,0,0,0" Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                                                </DockPanel>
                                            </materialDesign:ColorZone>

                                            <!-- 占位符列表 -->
                                            <ItemsControl Grid.Row="1" ItemsSource="{Binding DetectedExcelPlaceholders}" 
                  Margin="8" MaxHeight="120" ScrollViewer.VerticalScrollBarVisibility="Auto">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Button Style="{StaticResource MaterialDesignOutlinedButton}" 
                          Margin="4"
                          Content="{Binding}"
                          Command="{Binding DataContext.CopyToClipboardCommand, 
                                  RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                          CommandParameter="{Binding}"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                                <ItemsControl.Template>
                                                    <ControlTemplate TargetType="ItemsControl">
                                                        <ScrollViewer HorizontalScrollBarVisibility="Disabled" 
                               VerticalScrollBarVisibility="Auto">
                                                            <ItemsPresenter/>
                                                        </ScrollViewer>
                                                    </ControlTemplate>
                                                </ItemsControl.Template>
                                            </ItemsControl>
                                        </Grid>
                                    </materialDesign:Card>

                                    <!-- 输出目录选择 -->
                                    <DockPanel Margin="0,0,0,8">
                                        <Button DockPanel.Dock="Right" Margin="8,0,0,0"
                                                Style="{StaticResource MaterialDesignRaisedLightButton}"
                                                Command="{Binding BrowseOutputDirectoryCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <materialDesign:PackIcon Kind="FolderOutline" />
                                                <TextBlock Margin="8,0,0,0" Text="浏览" />
                                            </StackPanel>
                                        </Button>
                                        <materialDesign:Card>
                                            <DockPanel Margin="8">
                                                <materialDesign:PackIcon Kind="FolderOutline" DockPanel.Dock="Left"
                                                                         VerticalAlignment="Center" />
                                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center"
                                                           Text="{Binding OutputDirectory}" TextWrapping="NoWrap"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding OutputDirectory}" />
                                            </DockPanel>
                                        </materialDesign:Card>
                                    </DockPanel>

                                    <!-- 输出文件名模板设置 -->
                                    <TextBlock Text="输出文件名模板" Style="{StaticResource MaterialDesignBody1TextBlock}"
                                               Margin="0,8,0,8" />
                                    <materialDesign:Card>
                                        <TextBox Text="{Binding OutputFileNameTemplate}" Margin="8"
                                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                                 materialDesign:HintAssist.Hint="使用 {列名} 作为占位符，例如 {姓名}_{序号}_{时间}"
                                                 ToolTip="可使用的内置变量：{序号}、{时间}、{日期}"
                                                 BorderThickness="0" />
                                    </materialDesign:Card>
                                </StackPanel>
                            </materialDesign:Card>

                            <!-- 列选择区域 -->
                            <materialDesign:Card Margin="0,0,0,16" UniformCornerRadius="4">
                                <StackPanel Margin="16">
                                    <TextBlock Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                               Margin="0,0,0,16" FontWeight="Medium">
                                        选择需要映射的列
                                    </TextBlock>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <!-- 可用列列表 -->
                                        <materialDesign:Card Grid.Column="0" UniformCornerRadius="4">
                                            <DockPanel>
                                                <materialDesign:ColorZone Mode="PrimaryLight" DockPanel.Dock="Top"
                                                                          CornerRadius="4,4,0,0">
                                                    <StackPanel Orientation="Horizontal" Margin="8">
                                                        <materialDesign:PackIcon Kind="FormatListBulleted"
                                                            VerticalAlignment="Center" />
                                                        <TextBlock Text="可用列" Margin="8,0,0,0" FontWeight="Medium" />
                                                    </StackPanel>
                                                </materialDesign:ColorZone>
                                                <ListBox ItemsSource="{Binding AvailableColumns}"
                                                         Height="200"
                                                         ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                                    <ListBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <materialDesign:Card Margin="2" UniformCornerRadius="4">
                                                                <DockPanel Width="180">
                                                                    <Button DockPanel.Dock="Right"
                                                                            Style="{StaticResource MaterialDesignIconButton}"
                                                                            Command="{Binding DataContext.MoveColumnToSelectedCommand,
                                                                                RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                            CommandParameter="{Binding}">
                                                                        <materialDesign:PackIcon Kind="ArrowRight" />
                                                                    </Button>
                                                                    <TextBlock Text="{Binding}"
                                                                               VerticalAlignment="Center"
                                                                               Margin="8,0"
                                                                               TextTrimming="CharacterEllipsis"
                                                                               ToolTip="{Binding}" />
                                                                </DockPanel>
                                                            </materialDesign:Card>
                                                        </DataTemplate>
                                                    </ListBox.ItemTemplate>
                                                    <ListBox.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal" />
                                                        </ItemsPanelTemplate>
                                                    </ListBox.ItemsPanel>
                                                </ListBox>
                                            </DockPanel>
                                        </materialDesign:Card>

                                        <!-- 中间控制按钮 -->
                                        <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center"
                                                    Margin="16,0">
                                            <Button Style="{StaticResource MaterialDesignRaisedLightButton}"
                                                    Margin="0,4" Command="{Binding MoveAllColumnsToSelectedCommand}">
                                                <materialDesign:PackIcon Kind="ArrowRightBold" />
                                            </Button>
                                            <Button Style="{StaticResource MaterialDesignRaisedLightButton}"
                                                    Margin="0,4" Command="{Binding MoveAllColumnsToAvailableCommand}">
                                                <materialDesign:PackIcon Kind="ArrowLeftBold" />
                                            </Button>
                                        </StackPanel>

                                        <!-- 已选择列列表 -->
                                        <materialDesign:Card Grid.Column="2" UniformCornerRadius="4">
                                            <DockPanel>
                                                <materialDesign:ColorZone Mode="SecondaryLight" DockPanel.Dock="Top"
                                                                          CornerRadius="4,4,0,0" Cursor="">
                                                    <StackPanel Orientation="Horizontal" Margin="8">
                                                        <materialDesign:PackIcon Kind="PlaylistCheck"
                                                            VerticalAlignment="Center" />
                                                        <TextBlock Text="已选择列" Margin="8,0,0,0" FontWeight="Medium" />
                                                    </StackPanel>
                                                </materialDesign:ColorZone>
                                                <ListBox ItemsSource="{Binding SelectedColumns}"
                                                         Height="200"
                                                         ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                                    <ListBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <materialDesign:Card Margin="2" UniformCornerRadius="4">
                                                                <DockPanel Width="180">
                                                                    <Button DockPanel.Dock="Left"
                                                                            Style="{StaticResource MaterialDesignIconButton}"
                                                                            Command="{Binding DataContext.MoveColumnToAvailableCommand,
                                                                                RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                            CommandParameter="{Binding}">
                                                                        <materialDesign:PackIcon Kind="ArrowLeft" />
                                                                    </Button>
                                                                    <TextBlock Text="{Binding}"
                                                                               VerticalAlignment="Center"
                                                                               Margin="8,0"
                                                                               TextTrimming="CharacterEllipsis"
                                                                               ToolTip="{Binding}" />
                                                                </DockPanel>
                                                            </materialDesign:Card>
                                                        </DataTemplate>
                                                    </ListBox.ItemTemplate>
                                                    <ListBox.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal" />
                                                        </ItemsPanelTemplate>
                                                    </ListBox.ItemsPanel>
                                                </ListBox>
                                            </DockPanel>
                                        </materialDesign:Card>
                                    </Grid>
                                </StackPanel>
                            </materialDesign:Card>

                            <!-- 身份证信息提取区域 -->
                            <materialDesign:Card Margin="0,0,0,16" UniformCornerRadius="4">
                                <StackPanel Margin="16">
                                    <DockPanel>
                                        <materialDesign:PackIcon Kind="IdCard" VerticalAlignment="Center"
                                                                 Width="24" Height="24" Margin="0,0,16,0" />
                                        <TextBlock Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                                   Margin="0,0,0,8" FontWeight="Medium">
                                            身份证信息提取
                                        </TextBlock>
                                    </DockPanel>

                                    <materialDesign:Card UniformCornerRadius="4" Margin="0,8,0,0">
                                        <StackPanel Margin="16,8">
                                            <!-- 启用身份证提取的开关 -->
                                            <DockPanel Margin="0,0,0,16">
                                                <TextBlock Text="启用身份证信息提取"
                                                           Style="{StaticResource MaterialDesignBody1TextBlock}"
                                                           VerticalAlignment="Center" />
                                                <materialDesign:PackIcon Kind="Information"
                                                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                                         Margin="8,0,0,0" VerticalAlignment="Center"
                                                                         ToolTip="将自动提取身份证信息，包括性别、出生日期、籍贯等" />
                                                <ToggleButton IsChecked="{Binding EnableIdCardExtraction}"
                                                              HorizontalAlignment="Right" />
                                            </DockPanel>

                                            <!-- 身份证列选择 -->
                                            <DockPanel
                                                Visibility="{Binding EnableIdCardExtraction, 
                                                               Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <TextBlock Text="选择身份证列："
                                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                                           VerticalAlignment="Center" Margin="0,0,16,0" />
                                                <ComboBox ItemsSource="{Binding AvailableIdCardColumns}"
                                                          SelectedItem="{Binding SelectedIdCardColumn}"
                                                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                                          materialDesign:HintAssist.Hint="选择含身份证号的列"
                                                          HorizontalAlignment="Stretch" />
                                            </DockPanel>

                                            <!-- 提取信息说明 -->
                                            <Border BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                    BorderThickness="0,1,0,0" Margin="0,16,0,0" Padding="0,16,0,0"
                                                    Visibility="{Binding EnableIdCardExtraction, 
                                                          Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <!-- 最终解决方案 -->
                                                <Border BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                        BorderThickness="0,1,0,0" Margin="0,16,0,0" Padding="0,16,0,0"
                                                        Visibility="{Binding EnableIdCardExtraction, 
               Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <StackPanel>
                                                        <DockPanel LastChildFill="False" Margin="0,0,0,8">
                                                            <TextBlock Text="可在Word模板中使用以下占位符"
                                                                       Style="{StaticResource MaterialDesignBody2TextBlock}"
                                                                       FontWeight="Medium" DockPanel.Dock="Left" />

                                                            <materialDesign:PackIcon Kind="ContentCopy"
                                                                DockPanel.Dock="Right"
                                                                Margin="8,0,4,0" VerticalAlignment="Center" />
                                                            <TextBlock Text="点击可复制" DockPanel.Dock="Right"
                                                                       Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                       VerticalAlignment="Center" />
                                                        </DockPanel>

                                                        <ItemsControl ItemsSource="{Binding IdCardPlaceholders}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <WrapPanel />
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <materialDesign:Chip Content="{Binding}" Margin="4"
                                                                        Cursor="Hand"
                                                                        ToolTip="点击复制到剪贴板"
                                                                        Command="{Binding DataContext.CopyToClipboardCommand, 
                                              RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}">
                                                                        <materialDesign:Chip.Icon>
                                                                            <materialDesign:PackIcon Kind="ContentCopy"
                                                                                Width="16" Height="16" />
                                                                        </materialDesign:Chip.Icon>
                                                                    </materialDesign:Chip>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </Border>
                                            </Border>
                                        </StackPanel>
                                    </materialDesign:Card>
                                </StackPanel>
                            </materialDesign:Card>

                            <!-- 结果区域 -->
                            <materialDesign:Card Margin="0,0,0,16" UniformCornerRadius="4"
                                                 Visibility="{Binding ProcessResultText, Converter={StaticResource StringToVisibilityConverter}}">
                                <StackPanel Margin="16,8">
                                    <DockPanel>
                                        <materialDesign:PackIcon DockPanel.Dock="Left"
                                                                 Kind="{Binding ProcessSuccess, Converter={StaticResource BoolToIconConverter}, ConverterParameter=CheckCircleOutline;AlertCircleOutline}"
                                                                 Foreground="{Binding ProcessSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#4CAF50;#F44336'}"
                                                                 Width="24" Height="24" VerticalAlignment="Center" />
                                        <TextBlock Margin="8,0,0,0" Text="{Binding ProcessResultText}"
                                                   Foreground="{Binding ProcessSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#4CAF50;#F44336'}"
                                                   VerticalAlignment="Center" FontWeight="Medium" />
                                    </DockPanel>
                                </StackPanel>
                            </materialDesign:Card>

                            <!-- 进度条 -->
                            <materialDesign:Card UniformCornerRadius="4" Margin="0,0,0,16"
                                                 Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <StackPanel Margin="16,8">
                                    <TextBlock Text="正在处理..." Style="{StaticResource MaterialDesignBody1TextBlock}"
                                               Margin="0,0,0,8" />
                                    <ProgressBar Value="{Binding ProgressValue}" Height="8"
                                                 Style="{StaticResource MaterialDesignLinearProgressBar}" />
                                </StackPanel>
                            </materialDesign:Card>

                            <!-- 生成按钮 -->
                            <Button Style="{StaticResource MaterialDesignRaisedSecondaryButton}"
                                    Command="{Binding GenerateDocumentsCommand}"
                                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBoolConverter}}"
                                    HorizontalAlignment="Right"
                                    materialDesign:ButtonAssist.CornerRadius="8">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FileDocumentCheck" Width="24" Height="24" />
                                    <TextBlock Text="生成文档" Margin="8,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </materialDesign:Card>

            <!-- 忙碌指示器 -->
            <materialDesign:Card Grid.Row="1" UniformCornerRadius="8" Width="300" VerticalAlignment="Center"
                                 HorizontalAlignment="Center"
                                 Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                 materialDesign:ElevationAssist.Elevation="Dp8">
                <StackPanel Margin="16">
                    <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                 Value="0"
                                 IsIndeterminate="True" />
                    <TextBlock Text="正在处理，请稍后..."
                               Style="{StaticResource MaterialDesignBody1TextBlock}"
                               HorizontalAlignment="Center" Margin="0,16,0,0" />
                </StackPanel>
            </materialDesign:Card>
        </Grid>
    </materialDesign:DialogHost>
</Window>